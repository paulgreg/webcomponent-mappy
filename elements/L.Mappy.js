/*! L.Mappy 5.0.2 2014-03-27 */
!function(L){"use strict";var random_string=function(length){var str;for(str="";str.length<length;)str+=Math.random().toString(36)[2];return str},object_to_uri=function(obj){var data,key,value;data=[];for(key in obj)value=obj[key],data.push(window.encodeURIComponent(key)+"="+window.encodeURIComponent(value));return data.join("&")};L.Mappy={version:"5.0.2",_domain:"mappy.net",_token:null,_https:!1,setToken:function(token){this._token=token},_getToken:function(){return this._token},enableHttps:function(){this._https=!0},disableHttps:function(){this._https=!1},_getHttps:function(){return this._https},_getDomain:function(){return this._domain},JSONP:function(options){var callback,done,head,params,script;if(options=options?options:{},params={data:options.data||{},error:options.error||L.Util.falseFn,success:options.success||L.Util.falseFn,url:options.url||""},0===params.url.length)throw new Error("MissingUrl");return done=!1,callback=params.data[options.callback_name||"callback"]="jsonp_"+random_string(15),window[callback]=function(data){params.success(data),window[callback]=null},script=window.document.createElement("script"),script.src=params.url,script.src+=params.url.indexOf(!1)?"?":"&",script.src+=object_to_uri(params.data),script.async=!0,script.onerror=function(evt){return params.error({url:script.src,event:evt})},script.onload=script.onreadystatechange=function(){return done||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(done=!0,script.onload=script.onreadystatechange=null,!script||!script.parentNode)?void 0:script.parentNode.removeChild(script)},head=head||window.document.getElementsByTagName("head")[0],head.appendChild(script)}};var Attribution=L.Control.Attribution.extend({options:{prefix:'&copy; <a href="http://corporate.mappy.com/conditions-dutilisation/copyright/" title="Mappy">Mappy</a> - <a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>'},_layers:[],onAdd:function(map){return map.on("layeradd",function(evt){evt.layer instanceof TileLayer&&(this._layers.push(evt.layer),evt.layer.on("attributionsrefresh",this._refreshAttributions,this))},this),map.on("layerremove",function(evt){for(var i=this._layers.length-1;i>=0;i--)this._layers[i]===evt.layer&&(this._layers.splice(i,1),evt.layer.off("attributionsrefresh",this._refreshAttributions,this),this._refreshAttributions())},this),L.Control.Attribution.prototype.onAdd.call(this,map)},removeFrom:L.Util.falseFn,remove:L.Util.falseFn,clearAttributions:function(){this._attributions=[],this._update()},_refreshAttributions:function(){this.clearAttributions();for(var attribs=[],i=this._layers.length-1;i>=0;i--)attribs=attribs.concat(this._layers[i].getAttributions());for(var j=0;j<attribs.length;j++)this.addAttribution(attribs[j])}}),Layers=L.Control.Layers.extend({_onInputClick:function(evt){var input,layer,hasLayer,inputs=this._form.getElementsByTagName("input");if(evt){var target=evt.target;"checkbox"!==evt.target.type&&(target=evt.target.parentNode.getElementsByTagName("input")[0]);for(var i=0,len=inputs.length;len>i;i++)input=inputs[i],"checkbox"==input.type&&"checkbox"==target.type&&input!==target&&(input.checked=!1)}this._handlingClick=!0;for(var j=0,len2=inputs.length;len2>j;j++)input=inputs[j],layer=this._layers[input.layerId].layer,hasLayer=this._map.hasLayer(layer),input.checked&&!hasLayer?this._map.addLayer(layer):!input.checked&&hasLayer&&this._map.removeLayer(layer);this._handlingClick=!1,this._refocusOnMap()}}),Logo=L.Control.extend({options:{position:"bottomleft",dir:"../images/"},onAdd:function(){this._container=L.DomUtil.create("div","mappy-control-logo");var image=L.DomUtil.create("img","mappy-logo",this._container);return image.src=this.options.dir+(L.Browser.retina?"api-logo-2x.png":"api-logo.png"),image.style.display="block",image.width="50",image.height="12",image.onerror=function(){throw new Error("Logo is not accessible.")},this._container},removeFrom:L.Util.falseFn,remove:L.Util.falseFn}),TileLayer=L.TileLayer.extend({options:{minZoom:0,maxZoom:12,tileSize:384,subdomains:"1234",tms:!0},tileUrl:"http{h}://map{s}.{domain}/map/1.0/slab/{m}/{tileSize}/{z}/{x}/{y}",descrUrl:"http{h}://map1.{domain}/map/1.0/multi-descr/{m}/{tileSize}/{z}/{t}",descrInfos:{},attributions:[],layerItems:[],initialize:function(name,zIndex,options){options=L.setOptions(this,L.extend({h:L.Mappy._getHttps()?"s":"",m:name,zIndex:zIndex,domain:L.Mappy._getDomain()},options)),L.TileLayer.prototype.initialize.call(this,this.tileUrl,options)},onAdd:function(map){L.TileLayer.prototype.onAdd.call(this,map),this.on("load",this._onLoad)},onRemove:function(map){L.TileLayer.prototype.onRemove.call(this,map),this.off("load",this._onLoad)},getAttributions:function(){return this.attributions},_onLoad:function(){var bounds=this._map.getPixelBounds(),min=bounds.min.clone(),max=bounds.max.clone();min=min.divideBy(this.options.tileSize)._floor(),max=max.divideBy(this.options.tileSize)._floor();var tilesCoords=[];this._adjustTilePoint(min),this._adjustTilePoint(max);for(var x=min.x;x<=max.x;x++)for(var y=max.y;y<=min.y;y++)tilesCoords.push(x+","+y);tilesCoords.length>0&&this._requestDescr(tilesCoords)},_refreshAttributions:function(tiles){this.attributions=[],this.layerItems=[];for(var i=0;i<tiles.length;i++){var key=this.options.m+"/"+this._map.getZoom()+"/"+tiles[i].replace(",","/");if(this.descrInfos[key]){for(var j=0;j<this.descrInfos[key].copyrights.length;j++)this.attributions.push(this.descrInfos[key].copyrights[j].name);this.layerItems=this.layerItems.concat(this.descrInfos[key].items)}}this.fire("attributionsrefresh")},_requestDescr:function(tiles){for(var zoomLevel=this._map.getZoom(),reqTiles=[],i=0;i<tiles.length;i++){var key=this.options.m+"/"+zoomLevel+"/"+tiles[i].replace(",","/");this.descrInfos[key]||reqTiles.push(tiles[i])}if(reqTiles.length>0){var requestUrl=L.Util.template(this.descrUrl,L.extend({z:zoomLevel,t:reqTiles.join(";")},this.options)),self=this;L.Mappy.JSONP({url:requestUrl,success:function(response){for(var i=0;i<response.length;i++)self.descrInfos[self.options.m+"/"+response[i].sid]=response[i];self._refreshAttributions(tiles)}})}else this._refreshAttributions(tiles)}}),Tooltip=L.Class.extend({options:{width:"auto",minWidth:"",maxWidth:"",padding:"2px 4px",showDelay:500,hideDelay:500,mouseOffset:L.point(0,20),fadeAnimation:!0,trackMouse:!1},initialize:function(options){L.setOptions(this,options),this._createTip()},_createTip:function(){if(this._map=this.options.map,!this._map)throw new Error("No map configured for tooltip");this._container=L.DomUtil.create("div","leaflet-tooltip"),this._container.style.position="absolute",this._container.style.width=this._isNumeric(this.options.width)?this.options.width+"px":this.options.width,this._container.style.minWidth=this._isNumeric(this.options.minWidth)?this.options.minWidth+"px":this.options.minWidth,this._container.style.maxWidth=this._isNumeric(this.options.maxWidth)?this.options.maxWidth+"px":this.options.maxWidth,this._container.style.padding=this._isNumeric(this.options.padding)?this.options.padding+"px":this.options.padding,this.options.html&&this.setHtml(this.options.html),this.options.target&&this.setTarget(this.options.target),this._map._tooltipContainer.appendChild(this._container)},isVisible:function(){return this._showing},setTarget:function(target){target._icon&&(target=target._icon),target!==this._target&&(this._target&&this._unbindTarget(this._target),this._bindTarget(target),this._target=target)},_bindTarget:function(target){L.DomEvent.on(target,"mouseover",this._onTargetMouseover,this).on(target,"mouseout",this._onTargetMouseout,this).on(target,"mousemove",this._onTargetMousemove,this)},_unbindTarget:function(target){L.DomEvent.off(target,"mouseover",this._onTargetMouseover,this).off(target,"mouseout",this._onTargetMouseout,this).off(target,"mousemove",this._onTargetMousemove,this)},setHtml:function(html){if("string"==typeof html)this._container.innerHTML=html;else{for(;this._container.hasChildNodes();)this._container.removeChild(this._container.firstChild);this._container.appendChild(this._content)}this._sizeChanged=!0},setPosition:function(point){var mapSize=this._map.getSize(),container=this._container,containerSize=this._getElementSize(this._container);point=point.add(this.options.mouseOffset),point.x+containerSize.x>mapSize.x?(container.style.left="auto",container.style.right=mapSize.x-point.x+"px"):(container.style.left=point.x+"px",container.style.right="auto"),point.y+containerSize.y>mapSize.y?(container.style.top="auto",container.style.bottom=mapSize.y-point.y+2*this.options.mouseOffset.y+"px"):(container.style.top=point.y+"px",container.style.bottom="auto")},remove:function(){this._container.parentNode.removeChild(this._container),delete this._container,this._target&&this._unbindTarget(this._target)},show:function(point,html){Tooltip.activeTip&&Tooltip.activeTip!=this&&Tooltip.activeTip._hide(),Tooltip.activeTip=this,html&&this.setHtml(html),this.setPosition(point),this.options.showDelay?this._delay(this._show,this,this.options.hideDelay):this._show()},_show:function(){this._container.style.display="inline-block",L.DomUtil.addClass(this._container,"leaflet-tooltip-fade"),this._showing=!0},hide:function(){this.options.hideDelay?this._delay(this._hide,this,this.options.hideDelay):this._hide()},_hide:function(){this._timeout&&clearTimeout(this._timeout),L.DomUtil.removeClass(this._container,"leaflet-tooltip-fade"),this._container.style.display="none",this._showing=!1,Tooltip.activeTip===this&&delete Tooltip.activeTip},_delay:function(func,scope,delay){var me=this;this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(function(){func.call(scope),delete me._timeout},delay)},_isNumeric:function(val){return!isNaN(parseFloat(val))&&isFinite(val)},_getElementSize:function(el){var size=this._size;return(!size||this._sizeChanged)&&(size={},el.style.left="-999999px",el.style.right="auto",el.style.display="inline-block",size.x=el.offsetWidth,size.y=el.offsetHeight,el.style.left="auto",el.style.display="none",this._sizeChanged=!1),size},_onTargetMouseover:function(e){var point=this._map.mouseEventToContainerPoint(e);this.show(point)},_onTargetMousemove:function(e){if(L.DomEvent.stopPropagation(e),this.options.trackMouse){var point=this._map.mouseEventToContainerPoint(e);this.setPosition(point)}},_onTargetMouseout:function(){this.hide()}});L.Map.addInitHook(function(){this._tooltipContainer=L.DomUtil.create("div","leaflet-tooltip-container",this._container)}),function(){var originalOnAdd=L.Marker.prototype.onAdd,originalOnRemove=L.Marker.prototype.onRemove,originalSetIcon=L.Marker.prototype.setIcon;L.Marker.include({getTooltip:function(){return this._tooltip},onAdd:function(map){originalOnAdd.call(this,map),this.options.tooltip&&(this._tooltip=Tooltip(L.extend(this.options.tooltip,{target:this,map:map})))},onRemove:function(map){this._tooltip&&this._tooltip.remove(),originalOnRemove.call(this,map)},setIcon:function(icon){originalSetIcon.call(this,icon),this._tooltip&&this._tooltip.setTarget(this._icon)}})}();var projection={EARTH_RADIUS:6378137,DEGREE_TO_RADIAN:.017453292519943295,RADIAN_TO_DEGREE:57.29577951308232,project:function(latlng){var x=projection.EARTH_RADIUS*latlng.lng*.7071067811865476*projection.DEGREE_TO_RADIAN,y=projection.EARTH_RADIUS*Math.tan(.5*latlng.lat*projection.DEGREE_TO_RADIAN)*1.7071067811865475;return new L.Point(x,y)},unproject:function(point){var lng=1.4142135623730951*point.x/projection.EARTH_RADIUS*projection.RADIAN_TO_DEGREE,lat=2*Math.atan(.585786437626905*point.y/projection.EARTH_RADIUS)*projection.RADIAN_TO_DEGREE;return new L.LatLng(lat,lng)}},crs=L.extend({},L.CRS,{code:"ESRI:54016",projection:projection,transformation:new L.Transformation(1,14168658.027268294,-1,17449155.130499773),scale:function(zoom){var scales=[73795.09389202237,24598.364630674125,8199.454876891376,2733.1516256304585,911.0505418768195,303.68351395893984,101.22783798631328,33.74261266210443,11.247537554034809,3.7491791846782694,1.2497263948927564,.41657546496425213,.13885848832141737];return 1/scales[zoom]},getSize:function(zoom){var size=384*Math.pow(3,zoom);return new L.Point(size,size)}});L.Mappy.Map=L.Map.extend({_tileLayers:{},_tooltip:null,initialize:function(element,options){options=options||{},options.crs=crs;var zoomControlOptions=void 0!==options.zoomControl?options.zoomControl:!0;options.zoomControl=!1;var attributionControlOptions=void 0!==options.attributionControl?options.attributionControl:{};options.attributionControl=!1,this.baseLayers={standard:new TileLayer("standard",1,options.tileLayerOptions),hybrid:new TileLayer("hybrid",1,options.tileLayerOptions),photo:new TileLayer("photo",1,options.tileLayerOptions)},this.overlays={public_transport:new TileLayer("public_transport",2,options.tileLayerOptions),traffic:new TileLayer("traffic",2,options.tileLayerOptions)},L.Map.prototype.initialize.call(this,element,options),this.attributionControl=new Attribution(attributionControlOptions).addTo(this),this.logoControl=new Logo(options.logoControl||{}).addTo(this),(void 0===options.layersControl||options.layersControl)&&(this.layersControl=new Layers(this.baseLayers,this.overlays,options.layersControl||{}).addTo(this)),zoomControlOptions!==!1&&(this.zoomControl=new L.Control.Zoom(zoomControlOptions||{}).addTo(this)),this.addLayer(options.viewmode&&this._baseLayers[options.viewmode]?this.baseLayers[options.viewmode]:this.baseLayers.standard),this._tooltip=new Tooltip({map:this,showDelay:0,hideDelay:0}),this.on("mousemove",this._handleMousemove),this.on("move",this._tooltip.hide,this._tooltip),this.on("zoomstart",this._tooltip.hide,this._tooltip)},setViewmode:function(name){return name=name||"standard",this._setTileLayer(this.baseLayers,name)},setOverlay:function(name){return this._setTileLayer(this.overlays,name)},getTilelayer:function(type){var layers="overlay"===type?this.overlays:this.baseLayers;for(var layerName in layers)if(this.hasLayer(layers[layerName]))return layers[layerName];return null},_setTileLayer:function(layers,name){for(var layerName in layers)this.hasLayer(layers[layerName])&&this.removeLayer(layers[layerName]);return layers[name]&&this.addLayer(layers[name]),this},_handleMousemove:function(event){var items=this.getTilelayer().layerItems,overlay=this.getTilelayer("overlay");overlay&&(items=items.concat(overlay.layerItems));for(var i=0,found=!1;i<items.length&&!found;){var box=items[i].box;box.minx<event.latlng.lng&&event.latlng.lng<box.maxx&&box.miny<event.latlng.lat&&event.latlng.lat<box.maxy&&(this._tooltip.isVisible()||this._showItemTooltip(items[i]),found=!0),i++}found||this._tooltip.hide()},_showItemTooltip:function(item){var transportLabels={M:"Métro",S:"RER",T:"Train",TY:"Tramway"},lines=[],itemLine=item.properties.description.line;itemLine=itemLine instanceof Array?itemLine:[itemLine];for(var j=0;j<itemLine.length;j++)lines[itemLine[j].type]||(lines[itemLine[j].type]=[]),lines[itemLine[j].type].push(itemLine[j].num);var description="";for(var type in lines)description+="</p><p>"+(transportLabels[type]||type)+" : "+lines[type].join(", ");var popupPosition=this.latLngToContainerPoint(L.latLng((item.box.maxy+item.box.miny)/2,(item.box.maxx+item.box.minx)/2));this._tooltip.show(popupPosition,"<div><p>"+item.properties.description.label+description+"</p></div>")}}),L.Mappy.RouteModes={PEDESTRIAN:"ped",BIKE:"bik",MOTORBIKE:"mot",CAR:"midcar"},L.Mappy.Services={_checkToken:function(){if(!L.Mappy._getToken())throw new Error("Token must be set before using Mappy Services (see the docs).")},_decodePolyline:function(encoded){for(var len=encoded.length,tmp=[],decoded=[],index=0,lat=0,lng=0,decodeNextPoint=function(){var b,shift=0,result=0;do b=encoded.charCodeAt(index++)-63,result|=(31&b)<<shift,shift+=5;while(b>=32);return(1&result)>0?~(result>>1):result>>1};len>index;)tmp.push(decodeNextPoint());for(var i=0;i<tmp.length;i+=2)lat+=1e-5*tmp[i],lng+=1e-5*tmp[i+1],decoded.push([lat,lng]);return decoded},geocode:function(query,successCallback,failureCallback){this._checkToken(),query instanceof L.LatLng?query=query.lat+","+query.lng:query instanceof Array&&(query=query[0]+","+query[1]),L.Mappy.JSONP({url:"http"+(L.Mappy._getHttps()?"s":"")+"://axe."+L.Mappy._getDomain()+"/1v1/loc/get.aspx",data:{"opt.format":"json","opt.namedPlaceSearch":1,"opt.interactive":1,"opt.language":"FRE","opt.xmlOutput":"3v0",auth:L.Mappy._getToken(),fullAddress:query},success:function(response){if(!response.kml.Document)return[];var placemark=response.kml.Document.Placemark;placemark=placemark instanceof Array?placemark:[placemark],successCallback(placemark)},error:failureCallback})},route:function(steps){this._checkToken();var successCallback,failureCallback,data,step,elt,options={};if("function"==typeof arguments[1])successCallback=arguments[1],failureCallback=arguments[2];else{for(var name in arguments[1])options["opt."+name]=arguments[1][name];successCallback=arguments[2],failureCallback=arguments[3]}data=L.extend(options||{},{"start.x":"","start.y":"","via.x":"","via.y":"","end.x":"","end.y":"","opt.trace":1,"opt.format":"json","opt.rbver":5,auth:L.Mappy._getToken()});for(var i=0;i<steps.length;i++)step=L.latLng(steps[i]),0===i?elt="start":i===steps.length-1?elt="end":(elt="via",""!==data["via.x"]&&(data["via.x"]+=",",data["via.y"]+=",")),data[elt+".x"]+=step.lng,data[elt+".y"]+=step.lat;var that=this;L.Mappy.JSONP({url:"http"+(L.Mappy._getHttps()?"s":"")+"://axe."+L.Mappy._getDomain()+"/1v1/route/get.aspx",data:data,success:function(results){try{if(!results.routes.route.actions)throw new Error("No route found !");var polyline=that._decodePolyline(results.routes.route["polyline-definition"].polyline);results.routes.route["polyline-definition"].polyline=polyline,successCallback(results)}catch(error){failureCallback(error)}},error:failureCallback})}}}(window.L);